#!/bin/bash

# 默认目录
SLIMY_DIR="/etc/gxde-k9/slimy/"
TIMER_DIR="/etc/gxde-k9/timer/"

# 打印帮助信息
print_help() {
    cat << EOF
Usage: $0 [options]

Options:
  --slimy-dir <path>   Specify the directory to monitor for .slimy scripts.
  -h                   Show this help message and exit.

Description:
  K9 Lick Daemon gen 2 monitors a specified directory for .slimy scripts
  and executes them. By default, it monitors $SLIMY_DIR.
EOF
    exit 0
}

# 解析命令行参数
while [[ $# -gt 0 ]]; do
    case $1 in
        --slimy-dir)
            shift
            if [[ -z "$1" ]]; then
                echo "Error: --slimy-dir requires a directory path."
                exit 1
            fi
            SLIMY_DIR="$1"
            ;;
        -h|--help)
            print_help
            ;;
        *)
            echo "Unknown option: $1"
            print_help
            ;;
    esac
    shift
done

# 确保目录存在
if [[ ! -d "$SLIMY_DIR" ]]; then
    echo "Error: Slimy directory $SLIMY_DIR does not exist!"
    exit 1
fi

# 输出启动信息
echo "--------------------------------------------------------------"
echo "K9 Lick Daemon gen 2 is ready"
echo "I am $whoami"
echo "Watching slimy orders at $SLIMY_DIR"
echo "--------------------------------------------------------------"

# 捕获脚本终止信号，确保子进程被清理
trap 'echo "Cleaning up..."; kill $(jobs -p) 2>/dev/null; exit 0' SIGINT SIGTERM

# 运行所有 .slimy 脚本
echo "$(date +'%Y-%m-%d %H:%M:%S') - Searching for slimy scripts..."
find "$SLIMY_DIR" -name "*.slimy" -exec bash -c '{}' \; &

# 保持脚本运行
while true; do
#    echo "$(date +'%Y-%m-%d %H:%M:%S') - Slimy scripts are being monitored..."
    sleep 5
done
